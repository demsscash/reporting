name: ðŸ¦ Build BANKILY Windows Executables FIXED

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows-exe:
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ðŸ“¦ Install dependencies with fixed versions
      run: |
        python -m pip install --upgrade pip
        pip install pandas==2.1.4 openpyxl==3.1.2 xlrd==2.0.1 reportlab==4.0.8 tkcalendar==1.6.1
        pip install pyinstaller==6.3.0
        
    - name: ðŸ§ª Test imports before build
      run: |
        python -c "import pandas; print('âœ… pandas OK')"
        python -c "import openpyxl; print('âœ… openpyxl OK')" 
        python -c "import xlrd; print('âœ… xlrd OK')"
        python -c "import reportlab; print('âœ… reportlab OK')"
        python -c "import tkcalendar; print('âœ… tkcalendar OK')"
        
    - name: ðŸ“ Create assets directory if missing
      run: |
        if (-not (Test-Path "assets")) {
          New-Item -ItemType Directory -Name "assets"
          echo "ðŸ“ Assets directory created"
        } else {
          echo "ðŸ“ Assets directory already exists"
        }
      shell: powershell
        
    - name: ðŸ—ï¸ Build Hub executable
      run: |
        echo "Building BANKILY Generator Hub..."
        pyinstaller bankily_hub.spec --clean --noconfirm
        
    - name: ðŸ¢ Build Centres executable
      run: |
        echo "Building Multi-Centres..."
        pyinstaller centres.spec --clean --noconfirm
        
    - name: ðŸ›’ Build Commercants executable
      run: |
        echo "Building Multi-Commercants..."
        pyinstaller commercants.spec --clean --noconfirm
        
    - name: ðŸ‘¤ Build Agents executable
      run: |
        echo "Building Multi-Agents..."
        pyinstaller agents.spec --clean --noconfirm
    
    - name: ðŸ“ Verify build results
      run: |
        echo "=== Checking build results ==="
        if (Test-Path "dist") {
          Get-ChildItem dist -Recurse | ForEach-Object {
            if ($_.Extension -eq ".exe") {
              $size = [math]::Round($_.Length / 1MB, 2)
              echo "âœ… $($_.Name) - $size MB"
            }
          }
        } else {
          echo "âŒ No dist folder found"
          exit 1
        }
      shell: powershell
    
    - name: ðŸ“¦ Create release package
      run: |
        echo "Creating release package..."
        New-Item -ItemType Directory -Name "release_package" -Force
        
        # Copy executables
        if (Test-Path "dist") {
          Copy-Item "dist\*.exe" "release_package\" -ErrorAction SilentlyContinue
          echo "âœ… Executables copied"
        }
        
        # Copy assets if they exist
        if (Test-Path "assets") {
          Copy-Item "assets" "release_package\assets" -Recurse -ErrorAction SilentlyContinue
          echo "âœ… Assets copied"
        }
        
        # Create comprehensive README using here-string
        $readmeContent = @"
ðŸ¦ BANKILY Generator Package - Windows Executables
===============================================

ðŸ“‹ CONTENU DU PACKAGE:
=====================
âœ… BANKILY_Generator_Hub.exe         - Application principale (LANCEZ CELUI-CI)
âœ… BANKILY_Multi_Centres.exe         - GÃ©nÃ©rateur centres  
âœ… BANKILY_Multi_Commercants.exe     - GÃ©nÃ©rateur commerÃ§ants
âœ… BANKILY_Multi_Agents.exe          - GÃ©nÃ©rateur agents
ðŸ“ assets/                           - Logos (optionnel)

ðŸš€ UTILISATION:
==============
1. Extrayez TOUS les fichiers dans le mÃªme dossier
2. Lancez BANKILY_Generator_Hub.exe (menu principal)
3. Choisissez votre type de gÃ©nÃ©rateur
4. L'application correspondante s'ouvrira automatiquement

âš ï¸  IMPORTANT:
=============
â€¢ TOUS les fichiers .exe doivent Ãªtre dans le mÃªme dossier
â€¢ Ne dÃ©placez pas les fichiers sÃ©parÃ©ment
â€¢ Si erreur "dÃ©pendances manquantes", redÃ©marrez Windows
â€¢ Antivirus peut nÃ©cessiter une exception pour les .exe

ðŸ”§ DÃ‰PANNAGE:
============
ProblÃ¨me: "Erreur de dÃ©pendances" au lancement d'un gÃ©nÃ©rateur
Solution: 
1. Fermez toutes les applications BANKILY
2. RedÃ©marrez l'ordinateur  
3. Relancez BANKILY_Generator_Hub.exe
4. Si le problÃ¨me persiste, lancez directement le gÃ©nÃ©rateur voulu

ProblÃ¨me: Application ne s'ouvre pas
Solution:
1. VÃ©rifiez que Windows n'a pas bloquÃ© les fichiers
2. Clic droit > PropriÃ©tÃ©s > DÃ©bloquer (si prÃ©sent)
3. Ajoutez une exception antivirus pour le dossier
4. Lancez en tant qu'administrateur si nÃ©cessaire

ðŸ“ž SUPPORT:
==========
En cas de problÃ¨me, fournissez ces informations:
â€¢ Version Windows (Win 10/11)
â€¢ Message d'erreur exact
â€¢ Antivirus utilisÃ©
â€¢ Emplacement des fichiers

ðŸ’¡ CONSEILS:
===========
â€¢ CrÃ©ez un dossier dÃ©diÃ© (ex: C:\BANKILY\)
â€¢ Ajoutez le dossier aux exceptions antivirus
â€¢ Ã‰vitez les espaces dans le chemin du dossier
â€¢ Gardez tous les .exe ensemble

DÃ©veloppÃ© pour BANKILY Â© 2025
"@
        
        $readmeContent | Out-File -FilePath "release_package\README.txt" -Encoding UTF8
        
        # Create launch script using here-string
        $launchScript = @"
@echo off
echo ðŸ¦ BANKILY Generator Hub - Script de lancement
echo.
echo Tentative de lancement du Hub principal...
echo.

if not exist "BANKILY_Generator_Hub.exe" (
    echo âŒ ERREUR: BANKILY_Generator_Hub.exe non trouvÃ©
    echo.
    echo VÃ©rifiez que tous les fichiers sont prÃ©sents:
    echo - BANKILY_Generator_Hub.exe
    echo - BANKILY_Multi_Centres.exe  
    echo - BANKILY_Multi_Commercants.exe
    echo - BANKILY_Multi_Agents.exe
    echo.
    pause
    exit /b 1
)

echo âœ… Hub trouvÃ©, lancement...
start "" "BANKILY_Generator_Hub.exe"

echo âœ… Hub lancÃ©!
echo Ce script va se fermer dans 3 secondes...
timeout /t 3 /nobreak >nul
"@
        
        $launchScript | Out-File -FilePath "release_package\LANCER_BANKILY.bat" -Encoding ASCII
        
        echo "âœ… Package crÃ©Ã© avec documentation"
      shell: powershell
    
    - name: ðŸŽ¯ Upload executables
      uses: actions/upload-artifact@v4
      with:
        name: BANKILY-Windows-Executables-FIXED-${{ github.sha }}
        path: release_package/
        retention-days: 60
        if-no-files-found: error
    
    - name: ðŸ“Š Build summary
      shell: bash
      run: |
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        ## ðŸ¦ BANKILY Build Summary - FIXED VERSION
        
        ### âœ… Build completed successfully!
        
        ### ðŸ”§ CORRECTIONS APPLIQUÃ‰ES:
        - âœ… Hub PyInstaller nettoyage environnement subprocess
        - âœ… Variables PYINSTALLER_RESET_ENVIRONMENT
        - âœ… Isolation processus CREATE_NEW_PROCESS_GROUP
        - âœ… Spec files optimisÃ©s et exclusions Hub
        - âœ… Documentation et scripts de dÃ©pannage
        
        ### ðŸ“¦ Fichiers gÃ©nÃ©rÃ©s:
        - ðŸ¦ **BANKILY_Generator_Hub.exe** (Menu principal)
        - ðŸ¢ BANKILY_Multi_Centres.exe
        - ðŸ›’ BANKILY_Multi_Commercants.exe
        - ðŸ‘¤ BANKILY_Multi_Agents.exe
        - ðŸ“„ README.txt + LANCER_BANKILY.bat
        
        ### ðŸ“¥ Instructions de tÃ©lÃ©chargement:
        1. Cliquez sur l'onglet **Actions** de ce repository
        2. SÃ©lectionnez ce build (avec âœ… vert)
        3. TÃ©lÃ©chargez: `BANKILY-Windows-Executables-FIXED-${{ github.sha }}`
        4. **Extrayez TOUS les fichiers dans le MÃŠME dossier**
        5. Lancez **BANKILY_Generator_Hub.exe**
        
        ### ðŸŽ¯ PROBLÃˆME RÃ‰SOLU:
        Cette version corrige les erreurs de "dÃ©pendances manquantes"
        lors du lancement des gÃ©nÃ©rateurs depuis le Hub principal.
        
        ### âš ï¸ INSTRUCTIONS IMPORTANTES:
        - **Tous les .exe doivent Ãªtre dans le mÃªme dossier**
        - **Lancez toujours le Hub principal en premier**
        - **Si problÃ¨me: utilisez LANCER_BANKILY.bat**
        - **Ajoutez une exception antivirus si nÃ©cessaire**
        EOF